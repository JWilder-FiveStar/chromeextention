<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K-12 Network Telemetry Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
        }
        .header {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .kpi-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
        }
        .kpi-value {
            font-size: 2.5em;
            font-weight: bold;
            color: #1976D2;
            margin: 10px 0;
        }
        .kpi-label {
            color: #666;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .chart-title {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 20px;
            color: #333;
        }
        .data-table {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }
        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-good { background: #4CAF50; }
        .status-warning { background: #FF9800; }
        .status-error { background: #F44336; }
        .refresh-btn {
            background: #1976D2;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1em;
        }
        .refresh-btn:hover {
            background: #1565C0;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üåê K-12 Network Telemetry Dashboard</h1>
        <p>Real-time network performance monitoring for educational devices</p>
    <button class="refresh-btn" onclick="loadData(true)">üîÑ Refresh Data</button>
        <span id="lastUpdate" style="margin-left: 20px; color: #666;"></span>
    </div>

    <div class="kpi-grid">
        <div class="kpi-card">
            <div class="kpi-label">Average Download Speed</div>
            <div class="kpi-value" id="avgDownload">--</div>
            <div style="color: #666;">Mbps</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">Average Upload Speed</div>
            <div class="kpi-value" id="avgUpload">--</div>
            <div style="color: #666;">Mbps</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">Average Ping</div>
            <div class="kpi-value" id="avgPing">--</div>
            <div style="color: #666;">ms</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">Total Tests</div>
            <div class="kpi-value" id="totalTests">--</div>
            <div style="color: #666;">last 24h</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">Site Availability</div>
            <div class="kpi-value" id="siteAvailability">--</div>
            <div style="color: #666;">%</div>
        </div>
    </div>

    <div class="charts-grid">
        <div class="chart-container">
            <div class="chart-title">üìä Speed Performance Over Time</div>
            <canvas id="speedChart" width="400" height="200"></canvas>
        </div>
        <div class="chart-container">
            <div class="chart-title">üè¢ Performance by ISP</div>
            <canvas id="ispChart" width="400" height="200"></canvas>
        </div>
        <div class="chart-container">
            <div class="chart-title">üíª Device Type Distribution</div>
            <canvas id="deviceChart" width="400" height="200"></canvas>
        </div>
        <div class="chart-container">
            <div class="chart-title">üåç Geographic Distribution</div>
            <canvas id="geoChart" width="400" height="200"></canvas>
        </div>
    </div>

    <div class="data-table">
        <div class="chart-title" style="padding: 20px;">üìã Recent Test Results</div>
        <table>
            <thead>
                <tr>
                    <th>Time</th>
                    <th>User</th>
                    <th>Device</th>
                    <th>OS</th>
                    <th>OS Version</th>
                    <th>Location</th>
                    <th>ISP</th>
                    <th>Download</th>
                    <th>Upload</th>
                    <th>Ping</th>
                    <th>Sites</th>
                </tr>
            </thead>
            <tbody id="dataTableBody">
                <tr>
                    <td colspan="8" class="loading">Loading data...</td>
                </tr>
            </tbody>
        </table>
    </div>

        <div class="data-table" style="margin-top:30px;">
                <div class="chart-title" style="padding: 20px; display:flex; justify-content:space-between; align-items:center;">
                        <span>üõ∞Ô∏è Site Reachability (last 7 days)</span>
                        <button class="refresh-btn" onclick="loadReachability()">Refresh Reachability</button>
                </div>
                <table>
                        <thead>
                                <tr>
                                        <th>Site</th>
                                        <th>Availability %</th>
                                        <th>Checks</th>
                                        <th>OK</th>
                                        <th>Avg Latency (ms)</th>
                                        <th>Min</th>
                                        <th>Max</th>
                                        <th>Last Seen</th>
                                </tr>
                        </thead>
                        <tbody id="reachTableBody">
                                <tr><td colspan="8" class="loading">Loading reachability...</td></tr>
                        </tbody>
                </table>
        </div>

        <div id="reachModal" style="position:fixed; inset:0; background:rgba(0,0,0,.45); display:none; align-items:center; justify-content:center;">
            <div style="background:#fff; padding:20px; max-width:800px; width:90%; max-height:80%; overflow:auto; border-radius:8px;">
                <h2 id="modalTitle">Site Detail</h2>
                <div>
                    <table style="font-size:12px;">
                        <thead><tr><th>Time</th><th>Status</th><th>Latency</th><th>Error</th><th>Request ID</th></tr></thead>
                        <tbody id="reachDetailBody"><tr><td colspan="5" class="loading">Loading...</td></tr></tbody>
                    </table>
                </div>
                <div style="margin-top:10px; text-align:right;"><button class="refresh-btn" onclick="closeReachModal()">Close</button></div>
            </div>
        </div>

    <script>
        // Configuration
        const API_BASE = 'https://bigquery.googleapis.com/bigquery/v2';
        const PROJECT_ID = 'test-email-467802';
        const DATASET_ID = 'telemetry';
        const TABLE_ID = 'pubsub_raw';

        // Chart instances
        let speedChart, ispChart, deviceChart, geoChart;

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            initializeCharts();
            // Force fresh on first load so we don't rely on any stale cached file
            loadData(true);
            // Auto-refresh every 5 minutes (non-forced)
            setInterval(() => loadData(false), 5 * 60 * 1000);
        });

        function initializeCharts() {
            // Speed Chart
            const speedCtx = document.getElementById('speedChart').getContext('2d');
            speedChart = new Chart(speedCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Download (Mbps)',
                        data: [],
                        borderColor: '#1976D2',
                        backgroundColor: 'rgba(25, 118, 210, 0.1)',
                        tension: 0.4
                    }, {
                        label: 'Upload (Mbps)',
                        data: [],
                        borderColor: '#4CAF50',
                        backgroundColor: 'rgba(76, 175, 80, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Speed (Mbps)' }
                        }
                    }
                }
            });

            // ISP Chart
            const ispCtx = document.getElementById('ispChart').getContext('2d');
            ispChart = new Chart(ispCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Average Download Speed',
                        data: [],
                        backgroundColor: '#1976D2'
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Speed (Mbps)' }
                        }
                    }
                }
            });

            // Device Chart
            const deviceCtx = document.getElementById('deviceChart').getContext('2d');
            deviceChart = new Chart(deviceCtx, {
                type: 'doughnut',
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        backgroundColor: ['#1976D2', '#4CAF50', '#FF9800', '#F44336', '#9C27B0']
                    }]
                },
                options: {
                    responsive: true
                }
            });

            // Geographic Chart
            const geoCtx = document.getElementById('geoChart').getContext('2d');
            geoChart = new Chart(geoCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Tests by Location',
                        data: [],
                        backgroundColor: '#4CAF50'
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Number of Tests' }
                        }
                    }
                }
            });
        }

    async function loadData(forceFresh=false) {
            try {
                // Try to fetch real data from BigQuery via our API
        const response = await fetch(forceFresh ? '/api/data?fresh=1' : '/api/data');
                let data;
                
                if (response.ok) {
                    const rawData = await response.json();
                    console.log('API response OK, raw data length:', rawData.length);
                    if (rawData.length === 0) {
                        console.warn('API returned empty array');
                        showError('No data available - empty response from server');
                        return;
                    } else {
                        data = rawData.map(row => ({
                            timestamp: row.publish_time ? new Date(row.publish_time.replace(' ', 'T')+ 'Z') : new Date(),
                            userEmail: row.user_email || 'Unknown',
                            deviceType: row.device_type || 'Unknown',
                            deviceOs: row.device_os || 'Unknown',
                            deviceOsVersion: row.device_os_version || 'Unknown',
                            deviceMake: row.device_make || 'Unknown',
                            isp: row.isp_provider || 'Unknown',
                            city: row.city || 'Unknown',
                            downloadSpeed: (row.download_mbps ?? row.download_speed) === 'Failed' ? 'Failed' : ((row.download_mbps ?? row.download_speed) || 0),
                            uploadSpeed: (row.upload_mbps ?? row.upload_speed) || 0,
                            ping: (row.ping_ms ?? row.ping) === 'Failed' ? 'Failed' : ((row.ping_ms ?? row.ping) || 0),
                            sitesReachable: row.sites_ok ?? 0,
                            sitesTotal: row.sites_total ?? 12
                        }))
                        // Ensure newest first (descending publish time)
                        .sort((a,b) => b.timestamp - a.timestamp);
                        console.log('Processed data length:', data.length, 'newest timestamp:', data[0]?.timestamp);
                    }
                } else {
                    console.error('API response not OK:', response.status, response.statusText);
                    // Show error instead of sample data
                    showError(`${response.status} ${response.statusText} - Unable to fetch data from server`);
                    return;
                }
                
                updateKPIs(data);
                updateCharts(data);
                updateTable(data);
                
                const est = new Date().toLocaleTimeString('en-US',{timeZone:'America/New_York'});
                document.getElementById('lastUpdate').textContent = 
                    `Last updated (EST): ${est}`;
                
            } catch (error) {
                console.error('Error loading data:', error);
                console.error('Error stack:', error.stack);
                // Show error instead of sample data
                showError(`Error: ${error.message} - Unable to fetch data`);
                
                const est = new Date().toLocaleTimeString('en-US',{timeZone:'America/New_York'});
                document.getElementById('lastUpdate').textContent = 
                    `Last updated (EST): ${est} (error: ${error.message})`;
            }
        }

        // Reachability loading
        async function loadReachability() {
            const body = document.getElementById('reachTableBody');
            body.innerHTML = '<tr><td colspan="8" class="loading">Loading reachability...</td></tr>';
            try {
                const resp = await fetch('/api/reachability/summary');
                if (!resp.ok) throw new Error('summary fetch failed');
                const rows = await resp.json();
                if (!rows.length) {
                    body.innerHTML = '<tr><td colspan="8" class="loading">No reachability data</td></tr>';
                    return;
                }
                body.innerHTML = rows.map(r => `
                  <tr onclick="openReachModal('${r.url}')" style="cursor:pointer;">
                    <td>${r.url}</td>
                    <td>${r.availability_pct}%</td>
                    <td>${r.total_checks}</td>
                    <td>${r.ok_checks}</td>
                    <td>${r.avg_latency_ms}</td>
                    <td>${r.min_latency_ms}</td>
                    <td>${r.max_latency_ms}</td>
                    <td>${r.last_seen}</td>
                  </tr>`).join('');
            } catch (e) {
                body.innerHTML = `<tr><td colspan="8" class="loading">Error: ${e.message}</td></tr>`;
            }
        }

        async function openReachModal(url) {
            const modal = document.getElementById('reachModal');
            document.getElementById('modalTitle').textContent = `Site Detail: ${url}`;
            const tbody = document.getElementById('reachDetailBody');
            tbody.innerHTML = '<tr><td colspan="5" class="loading">Loading...</td></tr>';
            modal.style.display = 'flex';
            try {
                const resp = await fetch(`/api/reachability/site?url=${encodeURIComponent(url)}`);
                if (!resp.ok) throw new Error('detail fetch failed');
                const rows = await resp.json();
                if (!rows.length) {
                    tbody.innerHTML = '<tr><td colspan="5" class="loading">No data</td></tr>';
                    return;
                }
                tbody.innerHTML = rows.map(r => `
                   <tr>
                     <td>${r.ts}</td>
                     <td>${r.ok ? '‚úÖ' : (r.status ? r.status : '‚ùå')}</td>
                     <td>${r.latency_ms ?? ''}</td>
                     <td>${r.error || ''}</td>
                     <td style="max-width:140px; overflow:hidden; text-overflow:ellipsis;">${r.requestId}</td>
                   </tr>`).join('');
            } catch (e) {
                tbody.innerHTML = `<tr><td colspan="5" class="loading">Error: ${e.message}</td></tr>`;
            }
        }

        function closeReachModal() {
            document.getElementById('reachModal').style.display = 'none';
        }

        // Kick off reachability load after main data
        document.addEventListener('DOMContentLoaded', loadReachability);

        function updateKPIs(data) {
            // Filter out failed tests for KPI calculations
            const validData = data.filter(d => typeof d.downloadSpeed === 'number' && typeof d.ping === 'number');
            
            if (validData.length === 0) {
                document.getElementById('avgDownload').textContent = '--';
                document.getElementById('avgUpload').textContent = '--';
                document.getElementById('avgPing').textContent = '--';
            } else {
                const avgDownload = validData.reduce((sum, d) => sum + d.downloadSpeed, 0) / validData.length;
                const avgUpload = validData.reduce((sum, d) => sum + d.uploadSpeed, 0) / validData.length;
                const avgPing = validData.reduce((sum, d) => sum + d.ping, 0) / validData.length;
                
                document.getElementById('avgDownload').textContent = avgDownload.toFixed(1);
                document.getElementById('avgUpload').textContent = avgUpload.toFixed(1);
                document.getElementById('avgPing').textContent = avgPing.toFixed(0);
            }
            
            const totalTests = data.length;
            const avgSites = data.reduce((sum, d) => sum + (d.sitesReachable || 0), 0) / data.length;
            const avgTotalSites = data.reduce((sum, d) => sum + (d.sitesTotal || 0), 0) / data.length;
            const siteAvailability = avgTotalSites ? (avgSites / avgTotalSites) * 100 : 0;

            document.getElementById('totalTests').textContent = totalTests;
            document.getElementById('siteAvailability').textContent = siteAvailability.toFixed(1);
        }

        function updateCharts(data) {
            // Update speed chart (last 24 hours by hour)
            const hourlyData = groupByHour(data);
            speedChart.data.labels = Object.keys(hourlyData);
            speedChart.data.datasets[0].data = Object.values(hourlyData).map(h => h.avgDownload);
            speedChart.data.datasets[1].data = Object.values(hourlyData).map(h => h.avgUpload);
            speedChart.update();

            // Update ISP chart
            const ispData = groupByISP(data);
            ispChart.data.labels = Object.keys(ispData);
            ispChart.data.datasets[0].data = Object.values(ispData);
            ispChart.update();

            // Update device chart
            const deviceData = groupByDevice(data);
            deviceChart.data.labels = Object.keys(deviceData);
            deviceChart.data.datasets[0].data = Object.values(deviceData);
            deviceChart.update();

            // Update geographic chart
            const geoData = groupByCity(data);
            geoChart.data.labels = Object.keys(geoData);
            geoChart.data.datasets[0].data = Object.values(geoData);
            geoChart.update();
        }

        function updateTable(data) {
            const tbody = document.getElementById('dataTableBody');
            tbody.innerHTML = '';
            
            // Data already sorted descending; take first 10 (newest)
            const recentData = data.slice(0, 10);
            
            recentData.forEach(row => {
                const tr = document.createElement('tr');
                const speedStatus = (typeof row.downloadSpeed === 'number' && row.downloadSpeed > 25) ? 'good' : 
                                   (typeof row.downloadSpeed === 'number' && row.downloadSpeed > 10) ? 'warning' : 'error';
                const siteStatus = row.sitesReachable >= 11 ? 'good' : row.sitesReachable >= 9 ? 'warning' : 'error';
                
                tr.innerHTML = `
                    <td>${row.timestamp.toLocaleTimeString('en-US',{timeZone:'America/New_York'})}</td>
                    <td>${row.userEmail}</td>
                    <td>${row.deviceType}</td>
                    <td>${row.deviceOs}</td>
                    <td>${row.deviceOsVersion}</td>
                    <td>${row.city}</td>
                    <td>${row.isp}</td>
                    <td><span class="status-indicator status-${speedStatus}"></span>${row.downloadSpeed === 'Failed' ? 'Failed' : (typeof row.downloadSpeed === 'number' ? row.downloadSpeed.toFixed(1) + ' Mbps' : '0.0 Mbps')}</td>
                    <td>${typeof row.uploadSpeed === 'number' ? row.uploadSpeed.toFixed(1) + ' Mbps' : '0.0 Mbps'}</td>
                    <td>${row.ping === 'Failed' ? 'Failed' : (typeof row.ping === 'number' ? row.ping.toFixed(0) + ' ms' : '0 ms')}</td>
                    <td><span class="status-indicator status-${siteStatus}"></span>${row.sitesReachable}/${row.sitesTotal}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        // Helper functions for data grouping
        function groupByHour(data) {
            const hourly = {};
            data.forEach(d => {
                const hour = d.timestamp.getHours();
                if (!hourly[hour]) {
                    hourly[hour] = { total: 0, downloads: [], uploads: [] };
                }
                // Only include numeric values for charts
                if (typeof d.downloadSpeed === 'number') {
                    hourly[hour].downloads.push(d.downloadSpeed);
                }
                if (typeof d.uploadSpeed === 'number') {
                    hourly[hour].uploads.push(d.uploadSpeed);
                }
            });
            
            Object.keys(hourly).forEach(hour => {
                const downloads = hourly[hour].downloads;
                const uploads = hourly[hour].uploads;
                hourly[hour] = {
                    avgDownload: downloads.length > 0 ? downloads.reduce((a, b) => a + b, 0) / downloads.length : 0,
                    avgUpload: uploads.length > 0 ? uploads.reduce((a, b) => a + b, 0) / uploads.length : 0
                };
            });
            
            return hourly;
        }

        function groupByISP(data) {
            const ispData = {};
            data.forEach(d => {
                if (!ispData[d.isp]) ispData[d.isp] = [];
                // Only include numeric download speeds
                if (typeof d.downloadSpeed === 'number') {
                    ispData[d.isp].push(d.downloadSpeed);
                }
            });
            
            Object.keys(ispData).forEach(isp => {
                const speeds = ispData[isp];
                ispData[isp] = speeds.length > 0 ? speeds.reduce((a, b) => a + b, 0) / speeds.length : 0;
            });
            
            return ispData;
        }

        function groupByDevice(data) {
            const deviceData = {};
            data.forEach(d => {
                deviceData[d.deviceType] = (deviceData[d.deviceType] || 0) + 1;
            });
            return deviceData;
        }

        function groupByCity(data) {
            const cityData = {};
            data.forEach(d => {
                cityData[d.city] = (cityData[d.city] || 0) + 1;
            });
            return cityData;
        }

        function showError(message) {
            // Clear KPIs
            document.getElementById('avgDownload').textContent = '--';
            document.getElementById('avgUpload').textContent = '--';
            document.getElementById('avgPing').textContent = '--';
            document.getElementById('totalTests').textContent = '--';
            document.getElementById('siteAvailability').textContent = '--';
            
            // Show error in table
            document.getElementById('dataTableBody').innerHTML = 
                `<tr><td colspan="11" style="color: red; text-align: center; padding: 40px;">${message}</td></tr>`;
            
            // Clear charts
            if (speedChart) speedChart.data.labels = speedChart.data.datasets[0].data = speedChart.data.datasets[1].data = [], speedChart.update();
            if (ispChart) ispChart.data.labels = ispChart.data.datasets[0].data = [], ispChart.update();
            if (deviceChart) deviceChart.data.labels = deviceChart.data.datasets[0].data = [], deviceChart.update();
            if (geoChart) geoChart.data.labels = geoChart.data.datasets[0].data = [], geoChart.update();
        }
    </script>
</body>
</html>
